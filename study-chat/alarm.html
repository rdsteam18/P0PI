

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P0PI â€“ Task Manager with Alarms & Pomodoro Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
        }

        @media (max-width: 768px) {
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            .text-4xl {
                font-size: 2rem !important;
            }
            .text-5xl {
                font-size: 2.5rem !important;
            }
        }
        
        /* Custom CSS for parts that Tailwind can't handle easily */
        body {
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
        .custom-audio-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-audio-input::before {
            content: 'Select Audio File';
            display: inline-block;
            background: linear-gradient(to bottom, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 3px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            text-shadow: 1px 1px #fff;
            font-weight: 700;
            font-size: 10pt;
        }
        .custom-audio-input:hover::before {
            border-color: black;
        }
        .custom-audio-input:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }
        
        /* Animation for active alarms */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse-alarm {
            animation: pulse 2s infinite;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-indigo-700 mb-2">P0PI</h1>
            <p class="text-gray-600">Task Manager with Alarms & Pomodoro Timer</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Todo List Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-tasks mr-2 text-indigo-600"></i> Todo List
                </h2>
                <div class="flex mb-4">
                    <input type="text" id="todoInput" placeholder="Add a new task..." 
                           class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="addTodoBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="todoList" class="max-h-96 overflow-y-auto">
                    <!-- Todos will be added here -->
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    <span id="todoCount">0</span> tasks remaining
                </div>
            </div>

            <!-- Alarm Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-clock mr-2 text-red-500"></i> Alarm System
                </h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 font-medium">Quick Alarm</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-minutes="2" class="duration-btn bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm font-medium">2 min</button>
                        <button data-minutes="5" class="duration-btn bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm font-medium">5 min</button>
                        <button data-minutes="10" class="duration-btn bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm font-medium">10 min</button>
                        <button data-minutes="15" class="duration-btn bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm font-medium">15 min</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Set Alarm Time</label>
                    <input type="time" id="alarmTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Duration (minutes)</label>
                    <div class="flex space-x-2">
                        <button data-minutes="2" class="duration-btn flex-1 bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">2 min</button>
                        <button data-minutes="5" class="duration-btn flex-1 bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">5 min</button>
                        <button data-minutes="10" class="duration-btn flex-1 bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">10 min</button>
                        <input type="number" id="customDuration" placeholder="Custom" min="1" 
                               class="w-20 px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Alarm Sound</label>
                    <select id="alarmSoundSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="default">Default Alarm</option>
                        <option value="beep">Beep</option>
                        <option value="chime">Chime</option>
                        <option value="custom">Custom Sound</option>
                    </select>
                    <input type="file" id="alarmSoundFile" accept="audio/*" class="custom-audio-input w-full hidden">
                    <button id="previewSoundBtn" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-play mr-1"></i> Preview
                    </button>
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" id="loopSound" class="mr-2">
                        <label for="loopSound" class="text-sm text-gray-700">Loop sound</label>
                    </div>
                    <div class="mt-2 flex items-center">
                        <input type="number" id="soundDuration" placeholder="Duration (sec)" min="1" class="w-24 px-3 py-1 border border-gray-300 rounded mr-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <label class="text-sm text-gray-700">seconds (if not looping)</label>
                    </div>
                </div>
                
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="enableNotifications" class="mr-2">
                    <label for="enableNotifications" class="text-gray-700">Enable browser notifications</label>
                </div>
                
                <button id="setAlarmBtn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition flex items-center justify-center">
                    <i class="fas fa-bell mr-2"></i> Set Alarm
                </button>
                
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Active Alarms</h3>
                    <div id="activeAlarms" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Active alarms will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Pomodoro Timer Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-clock mr-2 text-purple-600"></i> Pomodoro Timer
                </h2>
                
                <div class="text-center py-4">
                    <div class="text-5xl font-bold text-purple-700 mb-2" id="pomodoroTime">25:00</div>
                    <div class="text-xl text-gray-600 mb-4" id="pomodoroPhase">Study Time</div>
                    
                    <div class="flex justify-center space-x-4 mb-6">
                        <button id="startPomodoroBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-play mr-2"></i> Start
                        </button>
                        <button id="resetPomodoroBtn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-redo mr-2"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Study Duration (minutes)</label>
                        <input type="number" id="studyDuration" min="1" max="60" value="25" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">Break Duration (minutes)</label>
                        <input type="number" id="breakDuration" min="1" max="60" value="5" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">Long Break Duration (minutes)</label>
                        <input type="number" id="longBreakDuration" min="1" max="60" value="15" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="autoStartNext" class="mr-2" checked>
                        <label for="autoStartNext" class="text-gray-700">Auto-start next phase</label>
                    </div>
                    
                    <div class="pt-2">
                        <div class="text-sm text-gray-600">Session Count: <span id="sessionCount">0</span>/4</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Audio element for alarm sound -->
    <audio id="alarmAudio"></audio>

    <script>
        // DOM Elements
        const todoInput = document.getElementById('todoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');
        const todoCount = document.getElementById('todoCount');
        
        const alarmTime = document.getElementById('alarmTime');
        const durationBtns = document.querySelectorAll('.duration-btn');
        const customDuration = document.getElementById('customDuration');
        const alarmSoundSelect = document.getElementById('alarmSoundSelect');
        const alarmSoundFile = document.getElementById('alarmSoundFile');
        const previewSoundBtn = document.getElementById('previewSoundBtn');
        const loopSound = document.getElementById('loopSound');
        const soundDuration = document.getElementById('soundDuration');
        const enableNotifications = document.getElementById('enableNotifications');
        const setAlarmBtn = document.getElementById('setAlarmBtn');
        const activeAlarms = document.getElementById('activeAlarms');
        const alarmAudio = document.getElementById('alarmAudio');
        
        const timezoneSelect = document.getElementById('timezoneSelect');
        const currentTime = document.getElementById('currentTime');
        const currentDate = document.getElementById('currentDate');
        const timezoneLabel = document.getElementById('timezoneLabel');
        const savedClocks = document.getElementById('savedClocks');
        const saveClockBtn = document.getElementById('saveClockBtn');
        
        // State variables
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
        let savedTimezones = JSON.parse(localStorage.getItem('savedTimezones')) || [];
        let audioFile = null;
        let notificationPermission = false;
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Pomodoro Timer Functions
        let pomodoroInterval;
        let isPomodoroRunning = false;
        let currentPhase = 'study'; // 'study', 'break', 'longBreak'
        let timeLeft = 25 * 60; // 25 minutes in seconds
        let sessionCount = 0;
        
        function startPomodoro() {
            if (isPomodoroRunning) return;
            
            isPomodoroRunning = true;
            document.getElementById('startPomodoroBtn').innerHTML = '<i class="fas fa-pause mr-2"></i> Pause';
            savePomodoroSettings();
            
            pomodoroInterval = setInterval(() => {
                timeLeft--;
                updatePomodoroDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(pomodoroInterval);
                    pomodoroComplete();
                }
            }, 1000);
        }
        
        function pausePomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            document.getElementById('startPomodoroBtn').innerHTML = '<i class="fas fa-play mr-2"></i> Start';
        }
        
        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            document.getElementById('startPomodoroBtn').innerHTML = '<i class="fas fa-play mr-2"></i> Start';
            
            const studyDuration = parseInt(document.getElementById('studyDuration').value) || 25;
            timeLeft = studyDuration * 60;
            currentPhase = 'study';
            updatePomodoroDisplay();
            savePomodoroSettings();
        }

        function savePomodoroSettings() {
            const settings = {
                studyDuration: document.getElementById('studyDuration').value,
                breakDuration: document.getElementById('breakDuration').value,
                longBreakDuration: document.getElementById('longBreakDuration').value,
                autoStartNext: document.getElementById('autoStartNext').checked,
                sessionCount,
                currentPhase,
                timeLeft
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
        }

        function loadPomodoroSettings() {
            const settings = JSON.parse(localStorage.getItem('pomodoroSettings'));
            if (settings) {
                document.getElementById('studyDuration').value = settings.studyDuration;
                document.getElementById('breakDuration').value = settings.breakDuration;
                document.getElementById('longBreakDuration').value = settings.longBreakDuration;
                document.getElementById('autoStartNext').checked = settings.autoStartNext;
                sessionCount = settings.sessionCount;
                currentPhase = settings.currentPhase;
                timeLeft = settings.timeLeft;
                updatePomodoroDisplay();
            }
        }
        
        function pomodoroComplete() {
            isPomodoroRunning = false;
            
            // Play alarm sound
            alarmAudio.src = '/sounds/chime.mp3';
            alarmAudio.play().catch(e => console.log('Autoplay prevented'));
            
            // Show notification
            if (notificationPermission) {
                new Notification('Pomodoro Complete!', {
                    body: currentPhase === 'study' ? 'Time for a break!' : 'Time to get back to work!',
                    icon: '/icon-192.png'
                });
            }
            
            // Determine next phase
            if (currentPhase === 'study') {
                sessionCount++;
                if (sessionCount >= 4) {
                    currentPhase = 'longBreak';
                    sessionCount = 0;
                } else {
                    currentPhase = 'break';
                }
            } else {
                currentPhase = 'study';
            }
            
            // Set time for next phase
            if (currentPhase === 'study') {
                timeLeft = (parseInt(document.getElementById('studyDuration').value) || 25) * 60;
            } else if (currentPhase === 'break') {
                timeLeft = (parseInt(document.getElementById('breakDuration').value) || 5) * 60;
            } else {
                timeLeft = (parseInt(document.getElementById('longBreakDuration').value) || 15) * 60;
            }
            
            updatePomodoroDisplay();
            
            // Auto-start next phase if enabled
            if (document.getElementById('autoStartNext').checked) {
                startPomodoro();
            }
        }
        
        function updatePomodoroDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('pomodoroTime').textContent = `${minutes}:${seconds}`;
            
            let phaseText = '';
            if (currentPhase === 'study') phaseText = 'Study Time';
            else if (currentPhase === 'break') phaseText = 'Short Break';
            else phaseText = 'Long Break';
            
            document.getElementById('pomodoroPhase').textContent = phaseText;
            document.getElementById('sessionCount').textContent = sessionCount;
        }
        
        // Initialize the app
        function init() {
            renderTodos();
            renderAlarms();
            renderSavedClocks();
            loadPomodoroSettings();
            updateClock();
            setInterval(updateClock, 1000);
            setInterval(checkAlarms, 1000);
            
            // Request notification permission if enabled
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission === 'granted';
                });
            }
        }
        
        // Todo List Functions
        function addTodo() {
            const text = todoInput.value.trim();
            if (text) {
                todos.push({ text, completed: false });
                saveTodos();
                renderTodos();
                todoInput.value = '';
            }
        }
        
        function toggleTodo(index) {
            todos[index].completed = !todos[index].completed;
            saveTodos();
            renderTodos();
        }
        
        function deleteTodo(index) {
            todos.splice(index, 1);
            saveTodos();
            renderTodos();
        }
        
        function saveTodos() {
            localStorage.setItem('todos', JSON.stringify(todos));
            updateTodoCount();
        }
        
        function renderTodos() {
            todoList.innerHTML = '';
            todos.forEach((todo, index) => {
                const todoItem = document.createElement('div');
                todoItem.className = `flex items-center justify-between p-3 border-b border-gray-200 ${todo.completed ? 'bg-gray-50' : ''}`;
                
                todoItem.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                               class="mr-3 h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="${todo.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${todo.text}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                const checkbox = todoItem.querySelector('input');
                const deleteBtn = todoItem.querySelector('button');
                
                checkbox.addEventListener('change', () => toggleTodo(index));
                deleteBtn.addEventListener('click', () => deleteTodo(index));
                
                todoList.appendChild(todoItem);
            });
            
            updateTodoCount();
        }
        
        function updateTodoCount() {
            const remaining = todos.filter(todo => !todo.completed).length;
            todoCount.textContent = remaining;
        }
        
        // Alarm System Functions
        function setAlarm() {
            const timeValue = alarmTime.value;
            if (!timeValue) {
                showToast('Please set a valid time for the alarm', 'error');
                return;
            }

            let duration = parseInt(customDuration.value);
            if (!duration || duration < 1) {
                // Check preset buttons
                const activeBtn = document.querySelector('.duration-btn.bg-gray-400');
                if (activeBtn) {
                    duration = parseInt(activeBtn.dataset.minutes);
                } else {
                    duration = 1; // Default to 1 minute if nothing selected
                }
            }
            
            const [hours, minutes] = timeValue.split(':').map(Number);
            const now = new Date();
            const alarmDate = new Date(
                now.getFullYear(),
                now.getMonth(),
                now.getDate(),
                hours,
                minutes
            );
            
            // If the time is already passed today, set for tomorrow
            if (alarmDate < now) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }
            
            const alarm = {
                id: Date.now(),
                time: alarmDate.getTime(),
                duration: duration * 60 * 1000, // Convert to milliseconds
                sound: audioFile,
                loop: loopSound.checked,
                soundDuration: soundDuration.value ? parseInt(soundDuration.value) * 1000 : null,
                notification: enableNotifications.checked,
                active: true
            };
            
            alarms.push(alarm);
            saveAlarms();
            renderAlarms();
            
            // Reset form
            alarmTime.value = '';
            customDuration.value = '';
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-gray-200');
            });
        }
        
        function cancelAlarm(id) {
            alarms = alarms.filter(alarm => alarm.id !== id);
            saveAlarms();
            renderAlarms();
            
            // If this was the currently ringing alarm, stop it
            if (id === ringingAlarmId) {
                stopAlarm();
            }
        }
        
        let ringingAlarmId = null;
        
        function checkAlarms() {
            const now = new Date().getTime();
            
            alarms.forEach(alarm => {
                if (alarm.active && now >= alarm.time && now <= alarm.time + alarm.duration) {
                    triggerAlarm(alarm.id);
                }
            });
        }
        
        function triggerAlarm(id) {
            const alarm = alarms.find(a => a.id === id);
            if (!alarm) return;
            
            ringingAlarmId = id;
            
            // Play sound
            if (alarm.sound) {
                alarmAudio.src = alarm.sound;
                alarmAudio.loop = alarm.loop;
                
                // Handle autoplay restrictions by creating and playing on user gesture
                const playPromise = alarmAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Autoplay prevented:', error);
                        // Show a button to play the sound
                        const playBtn = document.createElement('button');
                        playBtn.className = 'bg-red-500 text-white px-3 py-1 rounded mt-2';
                        playBtn.textContent = 'Play Alarm Sound';
                        playBtn.onclick = () => {
                            alarmAudio.play();
                            playBtn.remove();
                        };
                        
                        const alarmElement = document.querySelector(`[data-alarm-id="${id}"]`);
                        if (alarmElement) {
                            alarmElement.appendChild(playBtn);
                        }
                    });
                }
                
                // If not looping, stop after specified duration
                if (!alarm.loop && alarm.soundDuration) {
                    setTimeout(() => {
                        alarmAudio.pause();
                    }, alarm.soundDuration);
                }
            }
            
            // Show notification
            if (alarm.notification) {
                if (notificationPermission) {
                    new Notification('Alarm!', {
                        body: 'Your alarm is going off!',
                        icon: '/icon-192.png',
                        vibrate: [200, 100, 200]
                    });
                } else if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('Alarm!', {
                            body: 'Your alarm is going off!',
                            icon: '/icon-192.png',
                            vibrate: [200, 100, 200]
                        });
                    });
                }
            }
            
            // Update UI to show ringing alarm
            renderAlarms();
        }
        
        function stopAlarm() {
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            ringingAlarmId = null;
            renderAlarms();
        }
        
        function saveAlarms() {
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }
        
        function renderAlarms() {
            activeAlarms.innerHTML = '';
            
            if (alarms.length === 0) {
                activeAlarms.innerHTML = '<p class="text-gray-500 text-center py-4">No active alarms</p>';
                return;
            }
            
            // Sort alarms by time (soonest first)
            alarms.sort((a, b) => a.time - b.time);
            
            alarms.forEach(alarm => {
                const alarmDate = new Date(alarm.time);
                const now = new Date();
                const isRinging = ringingAlarmId === alarm.id;
                
                const alarmElement = document.createElement('div');
                alarmElement.className = `p-3 rounded-lg ${isRinging ? 'bg-red-100 pulse-alarm' : 'bg-gray-50'}`;
                alarmElement.dataset.alarmId = alarm.id;
                
                const timeStr = alarmDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = alarmDate.toLocaleDateString();
                
                alarmElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium">${timeStr}</div>
                            <div class="text-sm text-gray-600">${dateStr}</div>
                            <div class="text-xs mt-1">
                                Duration: ${alarm.duration / 60000} min
                                ${alarm.loop ? 'â€¢ Looping' : alarm.soundDuration ? `â€¢ Sound: ${alarm.soundDuration/1000}s` : ''}
                            </div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${isRinging ? `
                    <div class="mt-2 flex justify-center">
                        <button class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                            Stop Alarm
                        </button>
                    </div>
                    ` : ''}
                `;
                
                const cancelBtn = alarmElement.querySelector('button');
                cancelBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    cancelAlarm(alarm.id);
                });
                
                if (isRinging) {
                    const stopBtn = alarmElement.querySelector('.bg-red-500');
                    stopBtn.addEventListener('click', stopAlarm);
                }
                
                activeAlarms.appendChild(alarmElement);
            });
        }
        
        // World Clock Functions
        function updateClock() {
            const timezone = timezoneSelect.value;
            let now;
            
            if (timezone === 'local') {
                now = new Date();
                timezoneLabel.textContent = 'Local Time';
            } else {
                now = new Date(new Date().toLocaleString('en-US', { timeZone: timezone }));
                
                // Get the timezone name
                const timezoneParts = timezone.split('/');
                const city = timezoneParts[timezoneParts.length - 1].replace('_', ' ');
                timezoneLabel.textContent = `${city} Time`;
            }
            
            // Format time
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            currentTime.textContent = `${hours}:${minutes}:${seconds}`;
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDate.textContent = now.toLocaleDateString(undefined, options);
        }
        
        function saveCurrentClock() {
            const timezone = timezoneSelect.value;
            if (timezone === 'local') return;
            
            // Check if already saved
            if (savedTimezones.includes(timezone)) {
                alert('This time zone is already saved');
                return;
            }
            
            savedTimezones.push(timezone);
            saveClocks();
            renderSavedClocks();
        }
        
        function removeSavedClock(index) {
            savedTimezones.splice(index, 1);
            saveClocks();
            renderSavedClocks();
        }
        
        function saveClocks() {
            localStorage.setItem('savedTimezones', JSON.stringify(savedTimezones));
        }
        
        function renderSavedClocks() {
            savedClocks.innerHTML = '';
            
            if (savedTimezones.length === 0) {
                savedClocks.innerHTML = '<p class="text-gray-500 text-center py-4">No saved time zones</p>';
                return;
            }
            
            savedTimezones.forEach((tz, index) => {
                const now = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                const tzParts = tz.split('/');
                const city = tzParts[tzParts.length - 1].replace('_', ' ');
                
                const clockElement = document.createElement('div');
                clockElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                
                clockElement.innerHTML = `
                    <div>
                        <div class="font-medium">${city}</div>
                        <div class="text-sm text-gray-600">${timeStr}</div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const removeBtn = clockElement.querySelector('button');
                removeBtn.addEventListener('click', () => removeSavedClock(index));
                
                savedClocks.appendChild(clockElement);
            });
        }
        
        // Event Listeners
        addTodoBtn.addEventListener('click', addTodo);
        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTodo();
        });
        
        durationBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                durationBtns.forEach(b => {
                    b.classList.remove('bg-gray-400');
                    b.classList.add('bg-gray-200');
                });
                btn.classList.remove('bg-gray-200');
                btn.classList.add('bg-gray-400');
                customDuration.value = '';
            });
        });
        
        // Handle sound selection
        alarmSoundSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                alarmSoundFile.classList.remove('hidden');
            } else {
                alarmSoundFile.classList.add('hidden');
                audioFile = `/sounds/${e.target.value}.mp3`;
            }
        });

        // Handle custom sound file
        alarmSoundFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    audioFile = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Preview sound
        previewSoundBtn.addEventListener('click', () => {
            if (!audioFile) return;
            
            const previewAudio = new Audio(audioFile);
            previewAudio.play().catch(e => {
                alert('Please interact with the page first to enable audio');
            });
        });
        
        setAlarmBtn.addEventListener('click', setAlarm);
        
        timezoneSelect.addEventListener('change', updateClock);
        saveClockBtn.addEventListener('click', saveCurrentClock);
        
        // Request notification permission when checkbox is clicked
        enableNotifications.addEventListener('click', () => {
            if (enableNotifications.checked && 'Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission === 'granted';
                    if (!notificationPermission) {
                        enableNotifications.checked = false;
                    }
                });
            }
        });
        
        // Pomodoro Event Listeners
        document.getElementById('startPomodoroBtn').addEventListener('click', () => {
            if (isPomodoroRunning) {
                pausePomodoro();
            } else {
                startPomodoro();
            }
        });
        
        document.getElementById('resetPomodoroBtn').addEventListener('click', resetPomodoro);

        // Save settings when inputs change
        document.getElementById('studyDuration').addEventListener('change', savePomodoroSettings);
        document.getElementById('breakDuration').addEventListener('change', savePomodoroSettings);
        document.getElementById('longBreakDuration').addEventListener('change', savePomodoroSettings);
        document.getElementById('autoStartNext').addEventListener('change', savePomodoroSettings);
        
        // Initialize the app
        init();
    </script>
</body>
</html>